#The Schema version must be 2.2 as it is relative to the language/document/template type #referenced
schemaVersion: "2.2"
description: "Sample instance bootstrap and send CompleteLifeCycleAction signal."
mainSteps:
- action: "aws:runPowerShellScript"
  name: "BootStrapInstance"
  inputs:
    runCommand:

#The “-|” referenced below is 1.2 YAML Block Scalar and allows us to type LITERAL powershell code after it so long as EVERYTHING!!! is indented beyond the pipe character “|” below, alleviating any yaml syntax errors that may arise from entering powershell code within yaml code/construct
    - |  

      #This function returns instance metadata
        function Get-InstanceMetadata {
            try {
                return Invoke-RestMethod -Uri http://169.254.169.254/latest/dynamic/instance-identity/document
            }
            catch {
                Write-Error "Fail to retrieve IMDS."
                exit 1
            }    
        }
        
      #This function returns the ASG name
        function Start-PreBootStrapScriptAction {
            Set-DefaultAWSRegion -Region $Doc.region
            try {
                return (Get-EC2Tag -Filter @{Name="resource-id";Values=$Doc.instanceId} | Where-Object {$_.Key -eq 'aws:autoscaling:groupname'}).Value
            }
            catch {
                Write-Error "Fail to retrieve EC2 tags."
                exit 1
            } }
         
      #This function completes the lifecycle
        function Start-PostBootStrapScriptAction {

      #First IF statement assigns launch lifecycle hook to a variable
            if ($AsgName) {
                try {
                    $AsgLaunchHookName = (Get-ASLifecycleHooks -AutoScalingGroupName $AsgName | Where-Object {$_.LifecycleTransition -eq 'autoscaling:EC2_INSTANCE_LAUNCHING'}).LifecycleHookName
                }
                catch {
                    Write-Error "Fail to retrieve ASG launch hook name."
                    exit 1
                }
                
      #Second IF statement completes the lifecycle action
                if ($AsgLaunchHookName) {
                    try {
                        Complete-ASLifecycleAction -AutoScalingGroupName $AsgName -InstanceId $Doc.instanceId -LifecycleActionResult "CONTINUE" -LifecycleHookName $AsgLaunchHookName
                    }
                    catch {
                        Write-Error "Fail to complete ASG lifecycle action."
                        exit 1
                    }
                }
            }
      
        }
        
      #This function executes all tasks stated within
        function Start-BootstrapTasks {

      #IF statement checks for domain membership and proceeds to join instance to the domain
            If ((Get-WmiObject -Class Win32_ComputerSystem).Domain -ne "phc.local")
            {
                Set-ExecutionPolicy unrestricted -Force
                $Eth = Get-NetAdapter | where {$_.ifDesc -notlike "TAP*"} | foreach InterfaceAlias | select -First 1
                Set-DNSClientServerAddress -interfaceAlias $Eth -ServerAddresses  ("10.222.48.43")
                
                #Pass Domain Creds
                $username = "phc\ec2domainjoin"
                $File = read-s3object -bucketname phc-ec2-domain-join -key ec2.txt -file ec2.txt -region us-west-1
                $password = Get-Content $File | ConvertTo-SecureString -Key (Get-Content C:\Tools\join.txt)
                $cred = New-Object -typename System.Management.Automation.PSCredential($username, $password)
                
      #Setup the new name for the server
                $TDate = get-date
                $Hour = ($TDate.Hour).ToString()
                $Day = ($TDate.Day).ToString()
                $Month = ($TDate.Month).ToString()
                $Minute = ($TDate.Minute).ToString()
                $Second = ($TDate.Second).ToString()
                $Mili = ($TDate.Millisecond).ToString()
                $NewName = "SH" + $Month + $Day + $Hour + $Minute + $Second + $Mili
                
      #Adding to domain
                Try 
                {
                    If ($env:COMPUTERNAME -like "EC2AMAZ*") 
                    {   
                        Rename-Computer -NewName $NewName -Force
                    
                    }
       else{
                        Add-Computer -DomainName phc.local -OUPath "OU=CallCenter,OU=AWS-RDS,OU=Servers,DC=PHC,DC=local" -Credential $cred -Force -erroraction 'stop'
              }
                }
                
      #Get Error messages in a file
                Catch{
                echo $_.Exception | Out-File c:\tools\error-joindomain.txt -Append
                }
                
      #Clear STATIC DNS settings so that new dynamic addresses can populate
                Set-DNSClientServerAddress -interfaceAlias $Eth -ResetServerAddresses

      #Exit 3010 initiates a reboot and records where it left off and resumes there after booting
                exit 3010
            }


      #IF statement checks for membership of the awsrdsservice account (account which will manage #the amazonssmagent service) in the LOCAL Administrators group and proceeds to add it If #needed             
            If ((get-LocalGroupMember -Group Administrators -Member phc\awsrdsservice -ErrorAction SilentlyContinue).name -ne "phc\awsrdsservice")
            {
                Add-LocalGroupMember -Group Administrators -Member phc\awsrdsservice
            }
            
      #IF Statement sets the service account that manages the amazonssmagent to the account that #was just added to the administrators group and needed to execute administrative tasks as #instructed by Aws Systems Manager via the agent
            If ((gwmi win32_service -filter "name='AmazonSSMAgent'").StartName -notLike "*awsrdsservice*")
            {
                $File = read-s3object -bucketname phc-ec2-domain-join -key rds.txt -file rds.txt -region us-west-1
                $password = Get-Content $File | ConvertTo-SecureString -Key (Get-Content C:\Tools\awsrds.txt)
                $cred = New-Object -typename System.Management.Automation.PSCredential("phc\awsrdsservice",$password)
                $strpassword = $cred.getnetworkcredential().password
                $service = gwmi win32_service -filter "name='AmazonSSMAgent'"
                $service.Change($null,$null,$null,$null,$null,$null,"awsrdsservice@phc.local",$strpassword)
                exit 3010
            }
            
      #Last IF statement checks for domain membership assuming all prior steps executed correctly #and joins the RDS host to a collection managed by connection broker(s)
            If ((Get-WmiObject -Class Win32_ComputerSystem).Domain -eq "phc.local")
            {
                #Pass Domain Creds
                $username = "phc\ec2domainjoin"
                $File = read-s3object -bucketname phc-ec2-domain-join -key ec2.txt -file ec2.txt
                $password = Get-Content $File | ConvertTo-SecureString -Key (Get-Content C:\Tools\join.txt)
                $cred = New-Object -typename System.Management.Automation.PSCredential($username, $password)
            
                import-module "c:\tools\ps\Microsoft.ActiveDirectory.Management.dll"
                $CompName = $env:COMPUTERNAME + ".phc.local"
                $CompObject = Get-ADComputer -Identity $env:COMPUTERNAME
                $ActiveCB = (Get-RDConnectionBrokerHighAvailability -ConnectionBroker rdscb-221-1.phc.local).ActiveManagementServer
                Add-ADGroupMember "RDSSessionHosts" -Members $CompObject -Credential $cred
                Add-RDServer -Role RDS-RD-SERVER -ConnectionBroker $ActiveCB -Server $CompName
                Add-RDSessionHost -CollectionName "CallCenter" -ConnectionBroker $ActiveCB -SessionHost $CompName
                
      #Finally, Drop a file to signify document/process completion (Note: Future invocations will check for this file to determine if execution is needed or not)
                $Content = "Document Completed executing @"
                $Content + (get-date) | Out-file C:\Tools\CompletionCheck.txt
            }
        }
        


        ##########
        ## MAIN ##
        ##########
        $ErrorActionPreference = "Stop"
        $Doc = Get-InstanceMetaData

      #Finally, IF $Doc variable declared above is not null (assuming it assigned the proper data #returned by the function called) the following functions are called which are declared in the #prior pages
        if ($Doc) {
        
          if (!(test-path  "C:\Tools\CompletionCheck.txt"))
            {
            $AsgName = Start-PreBootStrapScriptAction

            Start-BootstrapTasks

            Start-PostBootStrapScriptAction
            }
          else
          {
            exit 0
          }
        }
